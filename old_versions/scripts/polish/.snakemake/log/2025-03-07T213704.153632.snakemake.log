host: emerald.prism
Building DAG of jobs...
SLURM run ID: a045d080-3a83-4081-8b42-22c0f744120a
Using shell: /usr/bin/bash
Provided remote nodes: 10
Job stats:
job                        count
-----------------------  -------
all                            1
attempt_circularization        1
close_gaps                     1
total                          3

Select jobs to execute...
Execute 1 jobs...

[Fri Mar  7 21:37:04 2025]
rule close_gaps:
    input: /private/groups/russelllab/jodie/merrill_23_wRi_genome/polished_scaffolds/merrill_23_all_basecalled/wRi/links_pilon.fasta
    output: /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta
    jobid: 2
    reason: Missing output files: /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta
    wildcards: sample=merrill_23_all_basecalled
    threads: 4
    resources: mem_mb=10000, mem_mib=9537, disk_mb=1000, disk_mib=954, tmpdir=<TBD>, slurm_partition=medium, runtime=30

No SLURM account given, trying to guess.
Guessed SLURM account: standard
Job 2 has been submitted with SLURM jobid 6793447 (log: /private/groups/russelllab/jodie/merrill_23_wRi_genome/de_novo_wRi_merrill_23_assembly/scripts/polish/.snakemake/slurm_logs/rule_close_gaps/merrill_23_all_basecalled/6793447.log).
[Fri Mar  7 21:37:45 2025]
Finished job 2.
1 of 3 steps (33%) done
Select jobs to execute...
Execute 1 jobs...

[Fri Mar  7 21:37:45 2025]
rule attempt_circularization:
    input: /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta, /private/groups/russelllab/jodie/merrill_23_wRi_genome/nanopore_data/basecalled/merrill_23_all_basecalled.wRi.fastq.gz
    output: /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta, /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
    jobid: 1
    reason: Missing output files: /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta; Input files updated by another job: /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta
    wildcards: sample=merrill_23_all_basecalled
    threads: 16
    resources: mem_mb=100000, mem_mib=95368, disk_mb=1000, disk_mib=954, tmpdir=<TBD>, slurm_partition=medium, runtime=240

Job 1 has been submitted with SLURM jobid 6793461 (log: /private/groups/russelllab/jodie/merrill_23_wRi_genome/de_novo_wRi_merrill_23_assembly/scripts/polish/.snakemake/slurm_logs/rule_attempt_circularization/merrill_23_all_basecalled/6793461.log).
[Sat Mar  8 01:39:32 2025]
Error in rule attempt_circularization:
    message: SLURM-job '6793461' failed, SLURM status is: 'TIMEOUT'. For further error details see the cluster/cloud log and the log files of the involved rule(s).
    jobid: 1
    input: /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta, /private/groups/russelllab/jodie/merrill_23_wRi_genome/nanopore_data/basecalled/merrill_23_all_basecalled.wRi.fastq.gz
    output: /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta, /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
    log: /private/groups/russelllab/jodie/merrill_23_wRi_genome/de_novo_wRi_merrill_23_assembly/scripts/polish/.snakemake/slurm_logs/rule_attempt_circularization/merrill_23_all_basecalled/6793461.log (check log file(s) for error details)
    shell:
        
        # Create output directory
        mkdir -p /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/
        
        # Use Circlator to attempt to circularize the Wolbachia genome
        circlator all --threads 16 /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta /private/groups/russelllab/jodie/merrill_23_wRi_genome/nanopore_data/basecalled/merrill_23_all_basecalled.wRi.fastq.gz /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//circlator_links
        
        # Check if the assembly was successfully circularized
        if grep -q "^>" /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//circlator_links/06.fixstart.fasta; then
            # Use the LINKS-based circularized genome
            cp /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//circlator_links/06.fixstart.fasta /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta
            echo "Using LINKS-based circularized genome" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        else
            # Fall back to the non-circularized assembly
            LINKS_CONTIGS=$(grep -c "^>" /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta)
            
            # Use the LINKS assembly
            cp /private/groups/russelllab/jodie/merrill_23_wRi_genome/gapfilled/merrill_23_all_basecalled/wRi/links_gapfilled.fasta /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta
            echo "Using LINKS assembly (not circularized). Contigs: $LINKS_CONTIGS" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        fi
        
        # Generate assembly statistics
        echo "===== Assembly Statistics =====" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        echo "Date: $(date)" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        echo "" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        
        # Count total contigs
        echo "Total contigs: $(grep -c "^>" /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta)" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        
        # Calculate N50, total size, etc.
        assembly-stats /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        
        # Check for circularity by looking for overlapping ends
        echo "" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        echo "===== Circularity Check =====" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        
        # Extract sequences for self-comparison
        seqtk seq -a /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/wRi_final_polished_circular.fasta > /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//temp.fa
        
        # For each contig, check if the start and end regions have overlap
        for SEQ in $(grep "^>" /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//temp.fa | sed 's/>//'); do
            echo "Checking circularity of contig: $SEQ" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
            
            # Extract the sequence
            seqtk subseq /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//temp.fa <(echo "$SEQ") > /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//single_contig.fa
            
            # Get the length
            LENGTH=$(seqtk comp /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//single_contig.fa | cut -f 2)
            
            # Extract first and last 1000 bp (or less if contig is smaller)
            OVERLAP=1000
            if [ $LENGTH -lt 2000 ]; then
                OVERLAP=$(echo "$LENGTH / 4" | bc)
            fi
            
            # Get start and end regions
            START_SEQ=$(head -n2 /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//single_contig.fa | tail -n1 | cut -c 1-$OVERLAP)
            END_SEQ=$(head -n2 /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//single_contig.fa | tail -n1 | rev | cut -c 1-$OVERLAP | rev)
            
            # Check for overlap
            echo $START_SEQ > /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//start.fa
            echo $END_SEQ > /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//end.fa
            
            # Calculate similarity
            IDENTITY=$(dnadiff /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//start.fa /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//end.fa 2>&1 | grep "AvgIdentity" | head -n1 | awk '{print $2}')
            
            echo "Terminal overlap identity: $IDENTITY%" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
            if (( $(echo "$IDENTITY > 95" | bc -l) )); then
                echo "Appears to be circular (>95% terminal identity)" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
            else
                echo "May not be circular (<95% terminal identity)" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
            fi
            echo "" >> /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled/assembly_stats.txt
        done
        
        # Cleanup
        rm -f /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//temp.fa /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//single_contig.fa /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//start.fa /private/groups/russelllab/jodie/merrill_23_wRi_genome/assembly_final/merrill_23_all_basecalled//end.fa
        
        (one of the commands exited with non-zero exit code; note that snakemake uses bash strict mode!)
    external_jobid: 6793461

Shutting down, this might take some time.
Exiting because a job execution failed. Look above for error message
Complete log: .snakemake/log/2025-03-07T213704.153632.snakemake.log
WorkflowError:
At least one job did not complete successfully.
